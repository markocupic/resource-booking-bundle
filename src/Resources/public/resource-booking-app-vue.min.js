"use strict";class resourceBookingApp{constructor(e,t){new Vue({el:e,data:{options:{requestToken:"",moduleKey:"",audio:{notifyOnNewBookingsAudio:"bundles/markocupicresourcebooking/audio/bell.mp3"},enableAudio:!0,autocloseWindowsAfter:2500,callbacks:{onBeforeBookingRequest:e=>!0,onAfterBookingRequest:()=>{}}},isReady:!1,mode:"main-window",lastResponseStatus:200,filterBoard:null,userIsLoggedIn:!1,loggedInUser:[],weekdays:[],timeSlots:[],rows:[],activeResourceTypeId:"undefined",activeResourceType:[],activeResourceId:"undefined",activeResource:[],activeWeekTstamp:0,activeWeek:[],bookingRepeatsSelection:[],bookingWindow:[],bookingFormValidation:[],intervals:[],autoCloseBookingWindowTimeout:null,messages:null,isIdle:!1,isBusy:!1},created:function(){window.navigator.userAgent.indexOf("MSIE ")>0&&alert("This plugin is not compatible with your browser. Please use a current browser (like Opera, Firefox, Safari or Google Chrome), that is not out of date."),this.options={...this.options,...t},window.setTimeout(()=>{this.fetchDataRequest()},2e3),this.intervals.fetchDataRequest=window.setInterval(()=>{this.isIdle||this.isBusy||this.fetchDataRequest()},15e3);window.setTimeout(()=>{this.initializeIdleDetector(document,3e5)},1e4),document.addEventListener("keyup",e=>{27===e.keyCode&&"booking-window"===this.mode&&this.hideBookingWindow()})},watch:{isReady:function(e,t){},activeResourceTypeId:function(e,t){this.applyFilterRequest(e,this.activeResourceId,this.activeWeekTstamp)},activeResourceId:function(e,t){this.applyFilterRequest(this.activeResourceTypeId,e,this.activeWeekTstamp)},activeWeekTstamp:function(e,t){this.applyFilterRequest(this.activeResourceTypeId,this.activeResourceId,e)},rows:function(e,t){if(0===e.length||0===t.length)return;let o=!1;Object.keys(e).forEach(i=>{Object.keys(e[i].cellData).forEach(s=>{!0===e[i].cellData[s].isBooked&&!1===t[i].cellData[s].isBooked&&e[i].cellData[s].mondayTimestampSelectedWeek===t[i].cellData[s].mondayTimestampSelectedWeek&&e[i].cellData[s].resourceId===t[i].cellData[s].resourceId&&(o=!0)})}),!0===o&&this.options.enableAudio&&this.playAudio(this.options.audio.notifyOnNewBookingsAudio)}},methods:{fetchDataRequest:function(){this.isBusy=!0;let e=new FormData;e.append("REQUEST_TOKEN",this.options.requestToken),e.append("action","fetchDataRequest"),e.append("moduleKey",this.options.moduleKey),fetch(window.location.href,{method:"POST",body:e,headers:{"x-requested-with":"XMLHttpRequest"}}).then(e=>(this.checkResponse(e),e.json())).then(e=>{if("success"===e.status)for(let t in e.data)this[t]=e.data[t];return e}).then(e=>{this.isReady=!0,this.isBusy=!1}).catch(e=>{this.isReady=!1,this.isBusy=!1})},applyFilterRequest:function(e,t,o){this.isBusy=!0,this.toggleBackdrop(!0);let i=new FormData;i.append("REQUEST_TOKEN",this.options.requestToken),i.append("action","applyFilterRequest"),i.append("resType",e),i.append("res",t),i.append("date",o),i.append("moduleKey",this.options.moduleKey),fetch(window.location.href,{method:"POST",body:i,headers:{"x-requested-with":"XMLHttpRequest"}}).then(e=>(this.checkResponse(e),e.json())).then(e=>("success"===e.status&&Object.keys(e.data).forEach(t=>{this[t]=e.data[t]}),e)).then(e=>{this.toggleBackdrop(!1),this.isBusy=!1}).catch(e=>{this.toggleBackdrop(!1),this.isBusy=!1})},bookingRequest:function(){let e=this.$el.querySelector(".booking-window form");e||console.error("Form not found");let t=new FormData(e);t.append("REQUEST_TOKEN",this.options.requestToken),t.append("action","bookingRequest"),t.append("resourceId",this.bookingWindow.activeTimeSlot.resourceId),t.append("description",this.$el.querySelectorAll('.booking-window [name="bookingDescription"]')[0].value),t.append("bookingRepeatStopWeekTstamp",this.$el.querySelectorAll(".booking-repeat-stop-week-tstamp")[0].value),t.append("moduleKey",this.options.moduleKey),Object.keys(this.bookingWindow.selectedTimeSlots).forEach(e=>{t.append("bookingDateSelection[]",this.bookingWindow.selectedTimeSlots[e])}),!0===this.options.callbacks.onBeforeBookingRequest.call(this,t)&&fetch(window.location.href,{method:"POST",body:t,headers:{"x-requested-with":"XMLHttpRequest"}}).then(e=>(this.checkResponse(e),e.json())).then(e=>{"success"===e.status?(this.bookingWindow.messages=e.data.messages,this.autoCloseBookingWindowTimeout=window.setTimeout(()=>{this.mode="main-window"},this.options.autocloseWindowsAfter)):this.bookingWindow.messages=e.data.messages,this.bookingWindow.showConfirmationMsg=!0,this.fetchDataRequest()}).then(e=>{this.options.callbacks.onAfterBookingRequest.call(this,t)}).catch(e=>{this.isReady=!1,this.bookingWindow.showConfirmationMsg=!0,this.fetchDataRequest()})},bookingFormValidationRequest:function(){let e=new FormData;e.append("REQUEST_TOKEN",this.options.requestToken),e.append("action","bookingFormValidationRequest"),e.append("resourceId",this.bookingWindow.activeTimeSlot.resourceId),e.append("bookingRepeatStopWeekTstamp",this.$el.querySelectorAll(".booking-repeat-stop-week-tstamp")[0].value),e.append("moduleKey",this.options.moduleKey),Object.keys(this.bookingWindow.selectedTimeSlots).forEach(t=>{e.append("bookingDateSelection[]",this.bookingWindow.selectedTimeSlots[t])}),fetch(window.location.href,{method:"POST",body:e,headers:{"x-requested-with":"XMLHttpRequest"}}).then(e=>(this.checkResponse(e),e.json())).then(e=>{"success"===e.status&&(this.bookingFormValidation=e.data,this.isReady=!0)}).catch(e=>{this.isReady=!1})},cancelBookingRequest:function(){let e=new FormData;e.append("REQUEST_TOKEN",this.options.requestToken),e.append("action","cancelBookingRequest"),e.append("bookingId",this.bookingWindow.activeTimeSlot.bookingId),e.append("deleteBookingsWithSameBookingUuid",this.bookingWindow.deleteBookingsWithSameBookingUuid),e.append("moduleKey",this.options.moduleKey),fetch(window.location.href,{method:"POST",body:e,headers:{"x-requested-with":"XMLHttpRequest"}}).then(e=>(this.checkResponse(e),e.json())).then(e=>{"success"===e.status?(this.bookingWindow.messages=e.data.messages,this.autoCloseBookingWindowTimeout=window.setTimeout(()=>{this.mode="main-window"},this.options.autocloseWindowsAfter)):this.bookingWindow.messages=e.data.messages,this.bookingWindow.deleteBookingsWithSameBookingUuid=!1,this.bookingWindow.showConfirmationMsg=!0,this.fetchDataRequest()}).catch(e=>{this.isReady=!1,this.bookingWindow.showConfirmationMsg=!0,this.fetchDataRequest(),this.bookingWindow.deleteBookingsWithSameBookingUuid=!1})},jumpWeekRequest:function(e,t){return t.preventDefault(),t.stopPropagation(),!this.isBusy&&(!(e===this.activeWeekTstamp||e<this.filterBoard.tstampFirstPossibleWeek||e>this.filterBoard.tstampLastPossibleWeek)&&void(this.activeWeekTstamp=e))},openBookingWindow:function(e,t){this.mode="booking-window",this.bookingWindow.deleteBookingsWithSameBookingUuid=!1,this.bookingWindow.selectedTimeSlots=[],this.bookingWindow.action=t,this.bookingWindow.showConfirmationMsg=!1,this.bookingWindow.activeTimeSlot=e,this.bookingWindow.messages={confirmation:null,info:null,error:null},this.bookingWindow.selectedTimeSlots.push(e.bookingCheckboxValue),this.bookingFormValidation=[],"showBookingForm"===t&&window.setTimeout(()=>{this.bookingFormValidationRequest()},500),window.setTimeout(()=>{let e=this.$el.querySelector('.booking-window input[name="bookingDescription"]');null!==e&&e.setAttribute("value","");let t=this.$el.querySelectorAll(".booking-window .booking-repeat-stop-week-tstamp option");t.length>0&&t.forEach(e=>e.removeAttribute("selected"))},20)},hideBookingWindow:function(){clearTimeout(this.autoCloseBookingWindowTimeout),this.mode="main-window"},toggleBackdrop:function(e=!0){if(e){let e=document.querySelectorAll(".resource-booking-backdrop-layer");e.length>0&&e.forEach(e=>e.parentNode.removeChild(e));let t=document.createElement("div");t.classList.add("resource-booking-backdrop-layer"),t.classList.add("show"),document.querySelector("body").append(t)}else window.setTimeout(()=>{let e=document.querySelectorAll(".resource-booking-backdrop-layer");e.length>0&&e.forEach(e=>e.parentNode.removeChild(e))},100)},checkResponse:function(e){this.lastResponseStatus=e.status,200!=e.status?this.isReady=!1:this.isReady=!0},initializeIdleDetectorOld:function(e){$(document).idle({onIdle:()=>{this.isIdle=!0},onActive:()=>{this.isIdle=!1,this.fetchDataRequest()},idle:e})},initializeIdleDetector:function(e,t){let o=t;["keydown","mousemove","mousedown","touchstart"].forEach(i=>{e.addEventListener(i,()=>{this.isIdle&&(this.isIdle=!1,this.fetchDataRequest()),o=t},!1)}),window.setInterval(()=>{this.isIdle||(o-=1e3)<=0&&(this.isIdle=!0)},1e3)},playAudio:function(e){let t=new Audio(e);t.setAttribute("id","rbbBellRingtone"),null===document.querySelector("body audio")&&document.querySelector("body").appendChild(t),t.play()}}})}}